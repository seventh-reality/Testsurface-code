<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Universal WebAR Experience</title>
  
  <!-- Required Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.0/dist/aframe-ar-nft.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
  
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      font-family: -apple-system, Arial, sans-serif;
    }
    
    #loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 1000;
    }
    
    #status {
      margin-top: 20px;
      text-align: center;
      max-width: 80%;
    }
    
    #compatibility-warning {
      display: none;
      background: #ff3b30;
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      max-width: 80%;
      text-align: center;
    }
    
    #start-button {
      margin-top: 20px;
      padding: 12px 24px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 16px;
      cursor: pointer;
      display: none;
    }
    
    #ar-overlay {
      position: fixed;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      text-shadow: 1px 1px 2px black;
      z-index: 999;
      pointer-events: none;
    }
    
    .arjs-loader {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="loading-screen">
    <h1>Loading AR Experience</h1>
    <div id="status">Initializing...</div>
    <div id="compatibility-warning"></div>
    <button id="start-button">Start AR</button>
  </div>
  
  <div id="ar-overlay">Point your camera at a surface or marker</div>

  <!-- Main AR Scene -->
  <a-scene 
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; antialias: true;"
    embedded
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    gesture-detector
    id="scene">
    
    <!-- Camera -->
    <a-camera gps-camera rotation-reader></a-camera>
    
    <!-- Lighting -->
    <a-light type="ambient" color="#FFF" intensity="0.5"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.5" position="-1 1 1"></a-light>
    
    <!-- Marker-based AR content (for AR.js) -->
    <a-marker preset="hiro">
      <a-box position="0 0.5 0" material="color: red"></a-box>
    </a-marker>
    
    <!-- WebXR/WebRTC content -->
    <a-entity id="webar-content" visible="false">
      <a-box position="0 0 -1" scale="0.5 0.5 0.5" color="blue"></a-box>
    </a-entity>
    
    <!-- Fallback content for non-AR devices -->
    <a-entity id="fallback-content" visible="false">
      <a-box position="0 0 -2" scale="0.5 0.5 0.5" color="green"></a-box>
    </a-entity>
  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const loadingScreen = document.getElementById('loading-screen');
      const statusElement = document.getElementById('status');
      const warningElement = document.getElementById('compatibility-warning');
      const startButton = document.getElementById('start-button');
      const scene = document.getElementById('scene');
      const webarContent = document.getElementById('webar-content');
      const fallbackContent = document.getElementById('fallback-content');
      
      // Detect device capabilities
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isAndroid = /Android/.test(navigator.userAgent);
      const isMobile = isIOS || isAndroid;
      
      // Check for WebXR support
      const hasWebXR = 'xr' in navigator && 'isSessionSupported' in navigator.xr;
      
      // Check for WebRTC support
      const hasWebRTC = !!navigator.mediaDevices && !!navigator.mediaDevices.getUserMedia;
      
      // Check for AR.js support
      const hasARJS = !!window.ARjs;
      
      // Main initialization function
      const initializeAR = async () => {
        statusElement.textContent = "Checking device capabilities...";
        
        try {
          // First try WebXR (modern devices)
          if (hasWebXR) {
            statusElement.textContent = "Attempting WebXR...";
            await initializeWebXR();
            return;
          }
          
          // Then try AR.js (older devices)
          if (hasARJS && hasWebRTC) {
            statusElement.textContent = "Attempting AR.js marker-based AR...";
            await initializeARJS();
            return;
          }
          
          // Fallback to simple WebRTC camera view
          if (hasWebRTC) {
            statusElement.textContent = "Using basic camera view...";
            await initializeWebRTC();
            return;
          }
          
          // Final fallback
          showFallback();
        } catch (error) {
          console.error("AR initialization failed:", error);
          handleError(error);
        }
      };
      
      // WebXR Initialization
      const initializeWebXR = async () => {
        try {
          const supported = await navigator.xr.isSessionSupported('immersive-ar');
          if (supported) {
            statusElement.textContent = "WebXR supported, starting session...";
            
            // Configure A-Frame for WebXR
            scene.setAttribute('webxr', 'optionalFeatures: hit-test; requiredFeatures: local-floor');
            
            // Show WebXR content
            webarContent.setAttribute('visible', 'true');
            
            // Wait for scene to load
            scene.addEventListener('loaded', () => {
              setTimeout(() => {
                loadingScreen.style.display = 'none';
                statusElement.textContent = "WebXR session started";
              }, 1000);
            });
            
            return;
          }
          throw new Error("WebXR AR not supported");
        } catch (error) {
          throw error;
        }
      };
      
      // AR.js Initialization
      const initializeARJS = () => {
        return new Promise((resolve) => {
          // AR.js is already initialized with the scene
          scene.addEventListener('arjs-nft-loaded', () => {
            statusElement.textContent = "AR.js ready";
            resolve();
          });
          
          scene.addEventListener('loaded', () => {
            setTimeout(() => {
              loadingScreen.style.display = 'none';
              statusElement.textContent = "AR.js session started";
            }, 1000);
          });
        });
      };
      
      // WebRTC Initialization (fallback)
      const initializeWebRTC = () => {
        return new Promise((resolve) => {
          // Just show the camera feed without AR
          scene.setAttribute('arjs', 'sourceType: webcam; debugUIEnabled: false');
          fallbackContent.setAttribute('visible', 'true');
          
          scene.addEventListener('loaded', () => {
            setTimeout(() => {
              loadingScreen.style.display = 'none';
              statusElement.textContent = "Camera view started";
            }, 1000);
          });
          
          resolve();
        });
      };
      
      // Show simple fallback content
      const showFallback = () => {
        warningElement.textContent = "AR features not available on this device. Showing 3D content.";
        warningElement.style.display = 'block';
        fallbackContent.setAttribute('visible', 'true');
        
        scene.addEventListener('loaded', () => {
          setTimeout(() => {
            loadingScreen.style.display = 'none';
          }, 1000);
        });
      };
      
      // Handle errors
      const handleError = (error) => {
        console.error("AR Error:", error);
        warningElement.textContent = `Error: ${error.message || 'AR initialization failed'}`;
        warningElement.style.display = 'block';
        
        // Show fallback options
        if (hasWebRTC) {
          startButton.style.display = 'block';
          startButton.textContent = "Try Basic Camera View";
          startButton.onclick = initializeWebRTC;
        } else {
          showFallback();
        }
      };
      
      // iOS-specific permission handling
      const handleIOSPermissions = () => {
        if (!isIOS) return;
        
        statusElement.textContent = "iOS device detected, checking permissions...";
        
        // iOS requires user interaction for camera access
        startButton.style.display = 'block';
        startButton.textContent = "Allow Camera Access";
        startButton.onclick = () => {
          statusElement.textContent = "Requesting camera permission...";
          
          // Create temporary video element to trigger permission
          const tempVideo = document.createElement('video');
          tempVideo.setAttribute('playsinline', '');
          tempVideo.setAttribute('webkit-playsinline', '');
          tempVideo.width = 1;
          tempVideo.height = 1;
          document.body.appendChild(tempVideo);
          
          navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
              // Clean up
              stream.getTracks().forEach(track => track.stop());
              document.body.removeChild(tempVideo);
              
              // Continue with AR initialization
              startButton.style.display = 'none';
              initializeAR();
            })
            .catch(err => {
              console.error("Camera permission denied:", err);
              document.body.removeChild(tempVideo);
              statusElement.textContent = "Please enable camera access in Settings";
              warningElement.textContent = "Camera access is required for AR features";
              warningElement.style.display = 'block';
            });
        };
      };
      
      // Start initialization
      if (isMobile) {
        handleIOSPermissions();
      }
      
      // For non-iOS devices or if iOS permissions are already granted
      if (!isIOS || (isIOS && !startButton.style.display !== 'none')) {
        initializeAR();
      }
    });
  </script>
</body>
</html>
