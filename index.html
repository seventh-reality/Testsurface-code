<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Advanced WebAR with SLAM Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/XRControllerModelFactory.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/effects/OutlineEffect.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/video/VideoTexture.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: Arial, sans-serif; 
            touch-action: none; 
            background-color: #000;
        }
        #ar-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
        }
        #start-button {
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            padding: 15px 30px; 
            font-size: 18px; 
            background: #007BFF; 
            color: white; 
            border: none;
            border-radius: 10px; 
            cursor: pointer; 
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        #reticle {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 2px solid rgba(0, 255, 0, 0.8);
            border-radius: 50%;
            pointer-events: none;
            display: none;
            z-index: 5;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }
        #hint {
            position: fixed;
            bottom: 80px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            z-index: 5;
            display: none;
        }
        #permission-button {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            font-size: 18px;
            background: #FF5722;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            z-index: 15;
            display: none;
        }
        #error-message {
            position: fixed;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: red;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            z-index: 30;
            display: none;
        }
        #video-controls {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: none;
        }
        #video-controls button {
            padding: 8px 16px;
            margin: 0 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid white;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="ar-container"></div>
    <div id="reticle"></div>
    <div id="hint">Point at a surface and tap to place object</div>
    <button id="start-button">Start AR</button>
    <button id="permission-button">Allow Camera Access</button>
    <div id="loading">
        <h2>Loading AR Experience</h2>
        <p id="progress">Initializing...</p>
    </div>
    <div id="error-message"></div>
    <div id="video-controls">
        <button id="play-btn">Play</button>
        <button id="pause-btn">Pause</button>
    </div>

    <script>
        // Enhanced Configuration
        const config = {
            modelUrl: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/AnimatedCube/glTF/AnimatedCube.gltf',
            videoUrl: 'https://sample-videos.com/video123/mp4/720/big_buck_bunny_720p_1mb.mp4',
            modelScale: 0.5,
            requiredFeatures: ['local', 'hit-test', 'anchors'],
            optionalFeatures: ['dom-overlay', 'light-estimation', 'depth-sensing'],
            domOverlay: { root: document.body },
            cameraConfig: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            },
            shadowQuality: 2048 // Shadow map size
        };

        // Global variables
        let scene, camera, renderer, xrSession;
        let hitTestSource = null, model = null;
        let videoMesh = null, videoTexture = null;
        let modelPlaced = false;
        let reticleVisible = false;
        let loadingManager = new THREE.LoadingManager();
        let gltfLoader = new THREE.GLTFLoader(loadingManager);
        let cameraPermissionGranted = false;
        let currentStream = null;
        let xrRefSpace = null;
        let controller = null;
        let controllerGrip = null;
        let hitTestSourceRequested = false;
        let resourcesLoaded = false;
        let arSupported = false;
        let videoElement = null;
        let shadowLight = null;
        let videoPlaying = false;

        // Initialize the app
        init();

        function init() {
            setupScene();
            setupLoadingManager();
            setupEventListeners();
            checkARSupport();
        }

        function setupScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.physicallyCorrectLights = true;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('ar-container').appendChild(renderer.domElement);

            // Advanced lighting with shadows
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);
            
            shadowLight = new THREE.DirectionalLight(0xffffff, 1.0);
            shadowLight.position.set(0, 5, 5);
            shadowLight.castShadow = true;
            shadowLight.shadow.mapSize.width = config.shadowQuality;
            shadowLight.shadow.mapSize.height = config.shadowQuality;
            shadowLight.shadow.camera.near = 0.5;
            shadowLight.shadow.camera.far = 20;
            shadowLight.shadow.camera.left = -5;
            shadowLight.shadow.camera.right = 5;
            shadowLight.shadow.camera.top = 5;
            shadowLight.shadow.camera.bottom = -5;
            scene.add(shadowLight);

            // Create video element for green screen playback
            videoElement = document.createElement('video');
            videoElement.src = config.videoUrl;
            videoElement.crossOrigin = 'anonymous';
            videoElement.loop = true;
            videoElement.muted = true;
            videoElement.playsInline = true;
            
            videoTexture = new THREE.VideoTexture(videoElement);
            videoTexture.minFilter = THREE.LinearFilter;
            videoTexture.magFilter = THREE.LinearFilter;
            videoTexture.format = THREE.RGBFormat;

            window.addEventListener('resize', onWindowResize);
        }

        function setupLoadingManager() {
            loadingManager.onStart = () => {
                document.getElementById('progress').textContent = 'Loading resources...';
            };

            loadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
                const progress = Math.round(itemsLoaded / itemsTotal * 100);
                document.getElementById('progress').textContent = `Loading ${progress}%`;
            };

            loadingManager.onLoad = () => {
                resourcesLoaded = true;
                document.getElementById('progress').textContent = 'Ready to start AR';
                updateStartButtonState();
            };

            loadingManager.onError = (url) => {
                showError(`Error loading ${url}`);
                document.getElementById('progress').textContent = `Error loading resources`;
            };
        }

        function setupEventListeners() {
            document.getElementById('start-button').addEventListener('click', startAR);
            document.getElementById('permission-button').addEventListener('click', requestCameraPermission);
            document.getElementById('play-btn').addEventListener('click', playVideo);
            document.getElementById('pause-btn').addEventListener('click', pauseVideo);
        }

        function checkARSupport() {
            document.getElementById('progress').textContent = 'Checking AR support...';
            
            if (!navigator.xr) {
                showError("WebXR not supported on this device");
                document.getElementById('start-button').style.display = 'none';
                return;
            }

            navigator.xr.isSessionSupported('immersive-ar')
                .then(supported => {
                    arSupported = supported;
                    if (!supported) {
                        showError("AR not supported on this device");
                        document.getElementById('start-button').style.display = 'none';
                    } else {
                        document.getElementById('progress').textContent = 'AR supported, loading model...';
                        loadModel();
                        checkCameraPermissions();
                    }
                })
                .catch(err => {
                    console.error("WebXR check failed:", err);
                    showError("Error checking AR support");
                });
        }

        function checkCameraPermissions() {
            navigator.permissions && navigator.permissions.query({ name: 'camera' })
                .then(permissionStatus => {
                    if (permissionStatus.state === 'granted') {
                        cameraPermissionGranted = true;
                    }
                    updateStartButtonState();
                })
                .catch(err => {
                    console.log("Camera permission API not available, proceeding...");
                });
        }

        function loadModel() {
            gltfLoader.load(config.modelUrl, gltf => {
                model = gltf.scene;
                model.scale.set(config.modelScale, config.modelScale, config.modelScale);
                model.visible = false;
                
                // Enable shadows for model
                model.traverse(child => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                
                scene.add(model);
                
                // Create video plane
                createVideoPlane();
                
                updateStartButtonState();
            }, undefined, error => {
                console.error("Error loading model:", error);
                showError("Error loading 3D model");
            });
        }

        function createVideoPlane() {
            const videoGeometry = new THREE.PlaneGeometry(1, 0.5625); // 16:9 aspect ratio
            const videoMaterial = new THREE.MeshBasicMaterial({
                map: videoTexture,
                transparent: true,
                opacity: 0.9
            });
            
            videoMesh = new THREE.Mesh(videoGeometry, videoMaterial);
            videoMesh.visible = false;
            videoMesh.position.set(0, 1.5, -1); // Position above the model
            scene.add(videoMesh);
        }

        function updateStartButtonState() {
            if (arSupported && resourcesLoaded) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('start-button').style.display = 'block';
            }
        }

        async function startAR() {
            try {
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('progress').textContent = 'Starting AR session...';
                document.getElementById('start-button').style.display = 'none';
                document.getElementById('hint').style.display = 'block';

                // Request AR session with advanced features
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: config.requiredFeatures,
                    optionalFeatures: config.optionalFeatures,
                    domOverlay: config.domOverlay
                });

                renderer.xr.setSession(xrSession);
                
                // Set up reference space with stabilization
                xrRefSpace = await xrSession.requestReferenceSpace('local');
                
                // Set up controller
                setupXRController();
                
                // Event listeners
                xrSession.addEventListener('end', onSessionEnd);

                // Start render loop with stabilization
                renderer.setAnimationLoop((timestamp, frame) => {
                    renderAR(frame);
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('video-controls').style.display = 'block';
            } catch (error) {
                console.error("Failed to start AR session:", error);
                showError("Failed to start AR session: " + error.message);
                document.getElementById('start-button').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                
                if (error.message.includes('camera')) {
                    document.getElementById('permission-button').style.display = 'block';
                }
            }
        }

        function setupXRController() {
            // Create a controller
            controller = renderer.xr.getController(0);
            controller.addEventListener('select', onSelect);
            scene.add(controller);

            // Optional: Add controller model
            const controllerModelFactory = new XRControllerModelFactory();
            controllerGrip = renderer.xr.getControllerGrip(0);
            controllerGrip.add(controllerModelFactory.createControllerModel(controllerGrip));
            scene.add(controllerGrip);
        }

        async function requestHitTestSource() {
            if (hitTestSourceRequested) return;
            
            try {
                const viewerSpace = await xrSession.requestReferenceSpace('viewer');
                hitTestSource = await xrSession.requestHitTestSource({
                    space: viewerSpace,
                    entityTypes: ['plane', 'mesh', 'point']
                });
                hitTestSourceRequested = true;
            } catch (error) {
                console.error("Failed to create hit test source:", error);
            }
        }

        function onSelect() {
            if (!model || !hitTestSource) return;
            
            if (reticleVisible) {
                // Place or move the model
                const reticle = document.getElementById('reticle');
                const screenX = (parseFloat(reticle.style.left) / window.innerWidth) * 2 - 1;
                const screenY = -((parseFloat(reticle.style.top) / window.innerHeight) * 2 + 1;
                
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(new THREE.Vector2(screenX, screenY), camera);
                
                const intersects = raycaster.intersectObjects(scene.children);
                if (intersects.length > 0) {
                    const point = intersects[0].point;
                    
                    // Place model with stabilization
                    model.position.copy(point);
                    model.visible = true;
                    modelPlaced = true;
                    
                    // Position video above the model
                    videoMesh.position.set(point.x, point.y + 1.5, point.z - 1);
                    videoMesh.visible = true;
                    
                    document.getElementById('hint').textContent = 'Tap again to move object';
                    
                    // Start video playback
                    playVideo();
                }
            }
        }

        function playVideo() {
            if (videoElement) {
                videoElement.play()
                    .then(() => {
                        videoPlaying = true;
                    })
                    .catch(err => {
                        console.error("Video play failed:", err);
                        showError("Video playback error: " + err.message);
                    });
            }
        }

        function pauseVideo() {
            if (videoElement && videoPlaying) {
                videoElement.pause();
                videoPlaying = false;
            }
        }

        function renderAR(frame) {
            if (!frame) return;
            
            // Request hit test source on first frame
            if (!hitTestSourceRequested) {
                requestHitTestSource();
            }
            
            // Update reticle position if we have a hit test source
            if (hitTestSource) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(xrRefSpace);
                    
                    // Show reticle
                    document.getElementById('reticle').style.display = 'block';
                    const pos = pose.transform.position;
                    const clipPos = new THREE.Vector3(pos.x, pos.y, pos.z).project(camera);
                    
                    const x = (clipPos.x * 0.5 + 0.5) * window.innerWidth;
                    const y = (clipPos.y * -0.5 + 0.5) * window.innerHeight;
                    document.getElementById('reticle').style.left = `${x}px`;
                    document.getElementById('reticle').style.top = `${y}px`;
                    
                    reticleVisible = true;
                } else {
                    document.getElementById('reticle').style.display = 'none';
                    reticleVisible = false;
                }
            }

            // Update light estimation if available
            if (frame.getLightEstimate) {
                const lightEstimate = frame.getLightEstimate();
                if (lightEstimate) {
                    // Update lighting based on environment
                    shadowLight.intensity = lightEstimate.primaryLightIntensity * 0.5;
                    shadowLight.color.setRGB(
                        lightEstimate.primaryLightColor.x,
                        lightEstimate.primaryLightColor.y,
                        lightEstimate.primaryLightColor.z
                    );
                }
            }

            // Update video texture if playing
            if (videoPlaying && videoTexture) {
                videoTexture.needsUpdate = true;
            }

            renderer.render(scene, camera);
        }

        function onSessionEnd() {
            if (xrSession) {
                xrSession.removeEventListener('end', onSessionEnd);
            }
            
            renderer.setAnimationLoop(null);
            xrSession = null;
            hitTestSource = null;
            hitTestSourceRequested = false;
            modelPlaced = false;
            
            if (model) {
                model.visible = false;
            }
            
            if (videoMesh) {
                videoMesh.visible = false;
            }
            
            pauseVideo();
            
            if (controller) {
                controller.removeEventListener('select', onSelect);
                scene.remove(controller);
                if (controllerGrip) {
                    scene.remove(controllerGrip);
                }
                controller = null;
                controllerGrip = null;
            }
            
            document.getElementById('start-button').style.display = 'block';
            document.getElementById('hint').style.display = 'none';
            document.getElementById('reticle').style.display = 'none';
            document.getElementById('video-controls').style.display = 'none';
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-message').style.display = 'block';
            setTimeout(() => {
                document.getElementById('error-message').style.display = 'none';
            }, 5000);
        }

        function requestCameraPermission() {
            document.getElementById('progress').textContent = 'Requesting camera access...';
            document.getElementById('permission-button').style.display = 'none';
            
            navigator.mediaDevices.getUserMedia({ video: config.cameraConfig })
                .then(stream => {
                    currentStream = stream;
                    stopStream(stream);
                    cameraPermissionGranted = true;
                    document.getElementById('progress').textContent = 'Camera access granted';
                    startAR();
                })
                .catch(err => {
                    console.error("Camera permission denied:", err);
                    showError('Camera access denied. Please allow camera access in your browser settings.');
                    document.getElementById('permission-button').style.display = 'block';
                });
        }

        function stopStream(stream) {
            if (!stream) return;
            stream.getTracks().forEach(track => {
                track.stop();
            });
        }
    </script>
</body>
</html>
