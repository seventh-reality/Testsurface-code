<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AR Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #f0f0f0;
            text-align: center;
        }
        
        #container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            color: #333;
        }
        
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px 5px;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        #status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
        }
        
        .instructions {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #webxr-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 1000;
        }
        
        #exit-webxr {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
        }
    </style>
    <!-- Model Viewer for AR Quick Look (iOS) -->
    <script type="module" src="https://unpkg.com/@google/model-viewer@^2.1.1/dist/model-viewer.min.js"></script>
    <!-- Three.js for WebXR (Android) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
</head>
<body>
    <div id="container">
        <h1>Universal AR Viewer</h1>
        <p>View 3D models in augmented reality on your device</p>
        
        <!-- Model Viewer for iOS -->
        <model-viewer 
            id="model-viewer"
            src="https://cdn.glitch.me/5d19e017-1621-4c8e-9c1b-8a1c6a0d1b3f%2FAstronaut.glb?v=1636390891856"
            ar
            ar-modes="quick-look scene-viewer webxr"
            camera-controls
            auto-rotate
            style="width: 100%; height: 400px; display: none;">
        </model-viewer>
        
        <!-- Buttons for different AR modes -->
        <button id="quicklook-btn" style="display: none;">View in AR (iOS)</button>
        <button id="webxr-btn" style="display: none;">View in AR (Android)</button>
        
        <div id="status">Detecting your device...</div>
        
        <div class="instructions">
            <h3>How to use:</h3>
            <p><strong>On iPhone:</strong> Tap "View in AR (iOS)"</p>
            <p><strong>On Android:</strong> Tap "View in AR (Android)"</p>
            <p>Point your camera at a flat surface and tap to place the model</p>
        </div>
    </div>

    <!-- WebXR Container (Android) -->
    <div id="webxr-container"></div>
    <button id="exit-webxr" style="display: none;">Exit AR</button>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // DOM elements
            const quicklookBtn = document.getElementById('quicklook-btn');
            const webxrBtn = document.getElementById('webxr-btn');
            const modelViewer = document.getElementById('model-viewer');
            const statusEl = document.getElementById('status');
            const webxrContainer = document.getElementById('webxr-container');
            const exitWebxrBtn = document.getElementById('exit-webxr');
            
            // Detect device type
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            // Initialize WebXR Polyfill
            if (!('xr' in navigator)) {
                new WebXRPolyfill();
            }
            
            // Check AR capabilities
            async function checkARSupport() {
                // iOS - AR Quick Look
                if (isIOS) {
                    modelViewer.style.display = 'block';
                    quicklookBtn.style.display = 'inline-block';
                    statusEl.textContent = 'Your device supports AR Quick Look';
                    return 'quicklook';
                }
                
                // Android - WebXR
                if (isAndroid && navigator.xr) {
                    try {
                        const supported = await navigator.xr.isSessionSupported('immersive-ar');
                        if (supported) {
                            webxrBtn.style.display = 'inline-block';
                            statusEl.textContent = 'Your device supports WebXR AR';
                            return 'webxr';
                        }
                    } catch (e) {
                        console.error('WebXR check failed:', e);
                    }
                }
                
                // No AR support
                statusEl.textContent = 'AR not supported on your device';
                statusEl.style.background = '#ffebee';
                return null;
            }
            
            // Initialize WebXR AR (Android)
            async function initWebXR() {
                statusEl.textContent = 'Starting AR...';
                
                try {
                    // Check camera permission
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Set up Three.js scene
                    const scene = new THREE.Scene();
                    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
                    
                    const renderer = new THREE.WebGLRenderer({ 
                        antialias: true, 
                        alpha: true,
                        preserveDrawingBuffer: true
                    });
                    renderer.setPixelRatio(window.devicePixelRatio);
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    renderer.xr.enabled = true;
                    webxrContainer.appendChild(renderer.domElement);
                    
                    // Add lights
                    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(0, 10, 0);
                    scene.add(directionalLight);
                    
                    // Load model
                    const loader = new THREE.GLTFLoader();
                    let model;
                    
                    loader.load(
                        'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r132/examples/models/gltf/Duck/glTF/Duck.gltf',
                        (gltf) => {
                            model = gltf.scene;
                            model.scale.set(0.5, 0.5, 0.5);
                            model.visible = false;
                            scene.add(model);
                            statusEl.textContent = 'Model loaded. Tap to place.';
                        },
                        undefined,
                        (error) => {
                            console.error('Error loading model:', error);
                            statusEl.textContent = 'Error loading model';
                        }
                    );
                    
                    // Start AR session
                    const session = await navigator.xr.requestSession('immersive-ar');
                    renderer.xr.setSession(session);
                    
                    // Show AR view
                    webxrContainer.style.display = 'block';
                    exitWebxrBtn.style.display = 'block';
                    statusEl.textContent = 'Point your camera at a flat surface';
                    
                    // Controller for placing model
                    const controller = renderer.xr.getController(0);
                    controller.addEventListener('select', () => {
                        if (model) {
                            model.visible = true;
                            model.position.copy(controller.position);
                        }
                    });
                    scene.add(controller);
                    
                    // Animation loop
                    renderer.setAnimationLoop(() => {
                        renderer.render(scene, camera);
                    });
                    
                    // Handle session end
                    session.addEventListener('end', () => {
                        renderer.setAnimationLoop(null);
                        webxrContainer.style.display = 'none';
                        exitWebxrBtn.style.display = 'none';
                        webxrContainer.removeChild(renderer.domElement);
                    });
                    
                } catch (error) {
                    console.error('WebXR AR failed:', error);
                    statusEl.textContent = 'Failed to start AR: ' + error.message;
                    statusEl.style.background = '#ffebee';
                }
            }
            
            // Set up event listeners
            quicklookBtn.addEventListener('click', () => {
                statusEl.textContent = 'Launching AR...';
                setTimeout(() => {
                    modelViewer.activateAR();
                    statusEl.textContent = 'Point your camera at a flat surface';
                }, 500);
            });
            
            webxrBtn.addEventListener('click', initWebXR);
            exitWebxrBtn.addEventListener('click', () => {
                const session = renderer?.xr?.getSession();
                if (session) session.end();
            });
            
            // Initialize
            const arType = await checkARSupport();
            if (!arType) {
                statusEl.style.background = '#ffebee';
            }
        });
    </script>
</body>
</html>
