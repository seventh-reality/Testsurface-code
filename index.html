<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebXR AR with Surface Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/XRControllerModelFactory.js"></script>
    <style>
        /* [Previous CSS remains exactly the same] */
    </style>
</head>
<body>
    <!-- [Previous HTML structure remains exactly the same] -->

    <script>
        // Configuration
        const config = {
            modelUrl: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
            modelScale: 0.3,
            requiredFeatures: ['local', 'hit-test'],
            optionalFeatures: ['dom-overlay'],
            domOverlay: { root: document.body },
            cameraConfig: {
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // Global variables
        let scene, camera, renderer, xrSession;
        let hitTestSource = null, model = null;
        let modelPlaced = false;
        let reticleVisible = false;
        let gltfLoader;
        let cameraPermissionGranted = false;
        let currentStream = null;
        let xrRefSpace = null;
        let controller = null;
        let controllerGrip = null;
        let hitTestSourceRequested = false;
        let resourcesLoaded = false;
        let arSupported = false;

        // Initialize the app
        init();

        function init() {
            setupScene();
            
            // Initialize loadingManager and gltfLoader together
            const loadingManager = new THREE.LoadingManager(
                () => { // onLoad callback
                    resourcesLoaded = true;
                    document.getElementById('progress').textContent = 'Ready to start AR';
                    updateStartButtonState();
                },
                (url, itemsLoaded, itemsTotal) => { // onProgress callback
                    const progress = Math.round(itemsLoaded / itemsTotal * 100);
                    document.getElementById('progress').textContent = `Loading ${progress}%`;
                },
                (url) => { // onError callback
                    document.getElementById('progress').textContent = `Error loading ${url}`;
                }
            );
            
            gltfLoader = new THREE.GLTFLoader(loadingManager);
            
            setupEventListeners();
            checkARSupport();
        }

        function setupScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.outputEncoding = THREE.sRGBEncoding;
            document.getElementById('ar-container').appendChild(renderer.domElement);

            // Improved lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 5, 5);
            scene.add(directionalLight);

            window.addEventListener('resize', onWindowResize);
        }

        function setupEventListeners() {
            document.getElementById('start-button').addEventListener('click', startAR);
            document.getElementById('permission-button').addEventListener('click', requestCameraPermission);
        }

        function checkARSupport() {
            document.getElementById('progress').textContent = 'Checking AR support...';
            
            if (!navigator.xr) {
                showError("WebXR not supported on this device");
                document.getElementById('start-button').style.display = 'none';
                return;
            }

            navigator.xr.isSessionSupported('immersive-ar')
                .then(supported => {
                    arSupported = supported;
                    if (!supported) {
                        showError("AR not supported on this device");
                        document.getElementById('start-button').style.display = 'none';
                    } else {
                        document.getElementById('progress').textContent = 'AR supported, loading model...';
                        loadModel();
                        checkCameraPermissions();
                    }
                })
                .catch(err => {
                    console.error("WebXR check failed:", err);
                    showError("Error checking AR support");
                });
        }

        function checkCameraPermissions() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                document.getElementById('progress').textContent = 'Camera API not available';
                return;
            }

            navigator.mediaDevices.getUserMedia({ video: config.cameraConfig })
                .then(stream => {
                    currentStream = stream;
                    stopStream(stream);
                    cameraPermissionGranted = true;
                    updateStartButtonState();
                })
                .catch(err => {
                    console.log("Camera access error:", err);
                    document.getElementById('permission-button').style.display = 'block';
                    document.getElementById('progress').textContent = 'Camera permission required';
                });
        }

        function loadModel() {
            gltfLoader.load(config.modelUrl, gltf => {
                model = gltf.scene;
                model.scale.set(config.modelScale, config.modelScale, config.modelScale);
                model.visible = false;
                scene.add(model);
                updateStartButtonState();
            }, undefined, error => {
                console.error("Error loading model:", error);
                showError("Error loading 3D model");
            });
        }

        function updateStartButtonState() {
            if (arSupported && resourcesLoaded) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('start-button').style.display = 'block';
            }
        }

        /* [Rest of the functions remain exactly the same as in previous version] */
        
    </script>
</body>
</html>
