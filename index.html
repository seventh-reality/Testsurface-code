<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WebXR AR with Surface Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/XRControllerModelFactory.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #ar-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        #ui {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 100;
        }
        
        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 4px;
            background-color: #4285f4;
            color: white;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #loading {
            color: white;
            text-align: center;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        #error {
            color: #ff4444;
            text-align: center;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Add the container element that the JavaScript expects -->
    <div id="ar-container"></div>
    
    <div id="ui">
        <div id="loading">
            <div id="progress">Initializing...</div>
        </div>
        <div id="error"></div>
        <button id="start-button" style="display: none;">Start AR Experience</button>
        <button id="permission-button" style="display: none;">Grant Camera Permission</button>
    </div>

    <script>
        // Configuration
        const config = {
            modelUrl: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
            modelScale: 0.3,
            requiredFeatures: ['local', 'hit-test'],
            optionalFeatures: ['dom-overlay'],
            domOverlay: { root: document.body },
            cameraConfig: {
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // Global variables
        let scene, camera, renderer, xrSession;
        let hitTestSource = null, model = null;
        let modelPlaced = false;
        let reticleVisible = false;
        let gltfLoader;
        let cameraPermissionGranted = false;
        let currentStream = null;
        let xrRefSpace = null;
        let controller = null;
        let controllerGrip = null;
        let hitTestSourceRequested = false;
        let resourcesLoaded = false;
        let arSupported = false;

        // Initialize the app
        init();

        function init() {
            setupScene();
            
            // Initialize loadingManager and gltfLoader together
            const loadingManager = new THREE.LoadingManager(
                () => { // onLoad callback
                    resourcesLoaded = true;
                    document.getElementById('progress').textContent = 'Ready to start AR';
                    updateStartButtonState();
                },
                (url, itemsLoaded, itemsTotal) => { // onProgress callback
                    const progress = Math.round(itemsLoaded / itemsTotal * 100);
                    document.getElementById('progress').textContent = `Loading ${progress}%`;
                },
                (url) => { // onError callback
                    document.getElementById('progress').textContent = `Error loading ${url}`;
                }
            );
            
            gltfLoader = new THREE.GLTFLoader(loadingManager);
            
            setupEventListeners();
            checkARSupport();
        }

        function setupScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.outputEncoding = THREE.sRGBEncoding;
            
            // Get the container element that we added to the HTML
            const container = document.getElementById('ar-container');
            if (container) {
                container.appendChild(renderer.domElement);
            } else {
                console.error("AR container not found");
                document.body.appendChild(renderer.domElement);
            }

            // Improved lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 5, 5);
            scene.add(directionalLight);

            window.addEventListener('resize', onWindowResize);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function setupEventListeners() {
            document.getElementById('start-button').addEventListener('click', startAR);
            document.getElementById('permission-button').addEventListener('click', requestCameraPermission);
        }

        function checkARSupport() {
            document.getElementById('progress').textContent = 'Checking AR support...';
            
            if (!navigator.xr) {
                showError("WebXR not supported on this device");
                document.getElementById('start-button').style.display = 'none';
                return;
            }

            navigator.xr.isSessionSupported('immersive-ar')
                .then(supported => {
                    arSupported = supported;
                    if (!supported) {
                        showError("AR not supported on this device");
                        document.getElementById('start-button').style.display = 'none';
                    } else {
                        document.getElementById('progress').textContent = 'AR supported, loading model...';
                        loadModel();
                        checkCameraPermissions();
                    }
                })
                .catch(err => {
                    console.error("WebXR check failed:", err);
                    showError("Error checking AR support");
                });
        }

        function checkCameraPermissions() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                document.getElementById('progress').textContent = 'Camera API not available';
                return;
            }

            navigator.mediaDevices.getUserMedia({ video: config.cameraConfig })
                .then(stream => {
                    currentStream = stream;
                    stopStream(stream);
                    cameraPermissionGranted = true;
                    updateStartButtonState();
                })
                .catch(err => {
                    console.log("Camera access error:", err);
                    document.getElementById('permission-button').style.display = 'block';
                    document.getElementById('progress').textContent = 'Camera permission required';
                });
        }

        function loadModel() {
            gltfLoader.load(config.modelUrl, gltf => {
                model = gltf.scene;
                model.scale.set(config.modelScale, config.modelScale, config.modelScale);
                model.visible = false;
                scene.add(model);
                updateStartButtonState();
            }, undefined, error => {
                console.error("Error loading model:", error);
                showError("Error loading 3D model");
            });
        }

        function updateStartButtonState() {
            if (arSupported && resourcesLoaded) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('start-button').style.display = 'block';
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function requestCameraPermission() {
            navigator.mediaDevices.getUserMedia({ video: config.cameraConfig })
                .then(stream => {
                    currentStream = stream;
                    stopStream(stream);
                    cameraPermissionGranted = true;
                    document.getElementById('permission-button').style.display = 'none';
                    document.getElementById('progress').textContent = 'Camera permission granted';
                    updateStartButtonState();
                })
                .catch(err => {
                    console.error("Camera permission error:", err);
                    showError("Failed to get camera permission");
                });
        }

        function stopStream(stream) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        function startAR() {
            if (!navigator.xr) {
                showError("WebXR not available");
                return;
            }

            const sessionInit = {
                optionalFeatures: config.optionalFeatures,
                requiredFeatures: config.requiredFeatures,
                domOverlay: config.domOverlay
            };

            navigator.xr.requestSession('immersive-ar', sessionInit)
                .then(onSessionStarted)
                .catch(err => {
                    console.error("Session creation error:", err);
                    showError("Failed to start AR session");
                });
        }

        function onSessionStarted(session) {
            xrSession = session;
            document.getElementById('ui').style.display = 'none';
            
            session.addEventListener('end', onSessionEnded);
            
            renderer.xr.setSession(session);
            
            // Setup AR session
            setupARSession();
            
            // Start the render loop
            renderer.setAnimationLoop(onXRFrame);
        }

        function setupARSession() {
            // Create a reference space of type 'local'
            xrSession.requestReferenceSpace('local').then(refSpace => {
                xrRefSpace = refSpace;
                
                // Request a hit test source
                xrSession.requestReferenceSpace('viewer').then(viewerRefSpace => {
                    xrSession.requestHitTestSource({ space: viewerRefSpace }).then(source => {
                        hitTestSource = source;
                    });
                });
                
                // Set up controller
                if (xrSession.inputSources && xrSession.inputSources.length > 0) {
                    setupController(xrSession.inputSources[0]);
                }
            });
        }

        function setupController(inputSource) {
            const controllerModelFactory = new XRControllerModelFactory();
            
            controller = renderer.xr.getController(0);
            controller.addEventListener('selectstart', onSelectStart);
            controller.addEventListener('selectend', onSelectEnd);
            scene.add(controller);
            
            controllerGrip = renderer.xr.getControllerGrip(0);
            controllerGrip.add(controllerModelFactory.createControllerModel(controllerGrip));
            scene.add(controllerGrip);
        }

        function onSelectStart() {
            if (model && reticleVisible) {
                modelPlaced = true;
            }
        }

        function onSelectEnd() {
            // Handle select end if needed
        }

        function onXRFrame(time, frame) {
            if (!xrSession) return;
            
            const session = frame.session;
            const pose = frame.getViewerPose(xrRefSpace);
            
            if (pose && hitTestSource) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const hitPose = hit.getPose(xrRefSpace);
                    
                    if (hitPose && model) {
                        if (!modelPlaced) {
                            model.visible = true;
                            model.position.setFromMatrixPosition(hitPose.transform.matrix);
                            model.quaternion.setFromRotationMatrix(hitPose.transform.matrix);
                            reticleVisible = true;
                        }
                    }
                } else {
                    if (model) model.visible = false;
                    reticleVisible = false;
                }
            }
            
            renderer.render(scene, camera);
        }

        function onSessionEnded() {
            if (xrSession) {
                xrSession.removeEventListener('end', onSessionEnded);
                xrSession = null;
            }
            
            document.getElementById('ui').style.display = 'block';
            renderer.setAnimationLoop(null);
            
            // Reset model placement
            modelPlaced = false;
            if (model) model.visible = false;
        }
    </script>
</body>
</html>
