<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Previous head content remains exactly the same] -->
</head>
<body>
    <!-- [Previous body content remains exactly the same] -->

    <script>
        // Enhanced Configuration
        const config = {
            modelUrl: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
            modelScale: 0.3,
            requiredFeatures: ['local', 'hit-test'],
            optionalFeatures: ['dom-overlay'],
            domOverlay: { root: document.body },
            cameraConfig: {
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // Global variables
        let scene, camera, renderer, xrSession;
        let hitTestSource = null, model = null;
        let modelPlaced = false;
        let reticleVisible = false;
        let loadingManager = new THREE.LoadingManager();
        let gltfLoader = new THREE.GLTFLoader(loadingManager);
        let cameraPermissionGranted = false;
        let currentStream = null;
        let xrRefSpace = null;
        let controller = null;
        let controllerGrip = null;
        let hitTestSourceRequested = false;
        let resourcesLoaded = false;
        let arSupported = false;

        // Initialize the app
        init();

        function init() {
            setupScene();
            setupLoadingManager();
            setupEventListeners();
            checkARSupport();
        }

        function setupScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
            scene.add(camera);

            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.getElementById('ar-container').appendChild(renderer.domElement);

            // Improved lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(0, 5, 5);
            scene.add(directionalLight);

            window.addEventListener('resize', onWindowResize);
        }

        function setupLoadingManager() {
            loadingManager.onStart = () => {
                document.getElementById('progress').textContent = 'Loading resources...';
            };

            loadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
                const progress = Math.round(itemsLoaded / itemsTotal * 100);
                document.getElementById('progress').textContent = `Loading ${progress}%`;
            };

            loadingManager.onLoad = () => {
                resourcesLoaded = true;
                document.getElementById('progress').textContent = 'Ready to start AR';
                updateStartButtonState();
            };

            loadingManager.onError = (url) => {
                console.error(`Error loading ${url}`);
                document.getElementById('progress').textContent = 'Error loading resources';
                updateStartButtonState(); // Still show button if model fails but AR is supported
            };
        }

        function setupEventListeners() {
            document.getElementById('start-button').addEventListener('click', startAR);
            document.getElementById('permission-button').addEventListener('click', requestCameraPermission);
        }

        function checkARSupport() {
            document.getElementById('progress').textContent = 'Checking AR support...';
            
            if (!navigator.xr) {
                showError("WebXR not supported on this device");
                document.getElementById('start-button').style.display = 'none';
                return;
            }

            navigator.xr.isSessionSupported('immersive-ar')
                .then(supported => {
                    arSupported = supported;
                    if (!supported) {
                        showError("AR not supported on this device");
                        document.getElementById('start-button').style.display = 'none';
                    } else {
                        document.getElementById('progress').textContent = 'AR supported, loading model...';
                        loadModel();
                        checkCameraPermissions();
                    }
                })
                .catch(err => {
                    console.error("WebXR check failed:", err);
                    showError("Error checking AR support");
                    document.getElementById('start-button').style.display = 'none';
                });
        }

        function checkCameraPermissions() {
            // First try the modern permissions API
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'camera' })
                    .then(permissionStatus => {
                        cameraPermissionGranted = permissionStatus.state === 'granted';
                        updateStartButtonState();
                        permissionStatus.onchange = () => {
                            cameraPermissionGranted = permissionStatus.state === 'granted';
                            updateStartButtonState();
                        };
                    })
                    .catch(err => {
                        console.log("Camera permission API not available, proceeding...");
                        updateStartButtonState();
                    });
            } else {
                // Fallback for browsers without permissions API
                updateStartButtonState();
            }
        }

        function loadModel() {
            gltfLoader.load(config.modelUrl, 
                gltf => {
                    model = gltf.scene;
                    model.scale.set(config.modelScale, config.modelScale, config.modelScale);
                    model.visible = false;
                    scene.add(model);
                    updateStartButtonState();
                },
                undefined, // Progress callback not needed here
                error => {
                    console.error("Error loading model:", error);
                    showError("Error loading 3D model");
                    // Still allow AR to start without model if needed
                    updateStartButtonState();
                }
            );
        }

        function updateStartButtonState() {
            // Show button if AR is supported and either:
            // 1. Model loaded successfully OR
            // 2. Model failed but we still want to allow AR session
            if (arSupported && (resourcesLoaded || true)) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('start-button').style.display = 'block';
            }
        }

        async function startAR() {
            try {
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('progress').textContent = 'Starting AR session...';
                document.getElementById('start-button').style.display = 'none';
                document.getElementById('hint').style.display = 'block';

                // Request AR session
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: config.requiredFeatures,
                    optionalFeatures: config.optionalFeatures,
                    domOverlay: config.domOverlay
                });

                renderer.xr.setSession(xrSession);
                
                // Set up reference space
                xrRefSpace = await xrSession.requestReferenceSpace('local');
                
                // Set up controller
                setupXRController();
                
                // Event listeners
                xrSession.addEventListener('end', onSessionEnd);

                // Start render loop
                renderer.setAnimationLoop((timestamp, frame) => {
                    renderAR(frame);
                });

                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error("Failed to start AR session:", error);
                showError("Failed to start AR: " + error.message);
                document.getElementById('start-button').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                
                if (error.message.includes('camera')) {
                    document.getElementById('permission-button').style.display = 'block';
                }
            }
        }

        // [Rest of the functions remain exactly the same as in previous version]
        
    </script>
</body>
</html>
