<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Markerless AR with SLAM (Older iPhone Compatible)</title>
    
    <!-- Polyfills for older devices -->
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js"></script>
    
    <!-- Three.js with GLTFLoader included -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
    
    <!-- WebAR.rocks for SLAM (optimized for iOS) -->
    <script src="https://cdn.jsdelivr.net/gh/WebAR-rocks/webar.rocks.three@latest/dist/webar.rocks.three.min.js"></script>
    
    <style>
        body {
            margin: 0;
            overflow: hidden;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        
        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            margin-top: 1em;
            padding: 0 20px;
        }
        
        #error-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            color: white;
            z-index: 10000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #start-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #webar-container {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: none;
        }
        
        #webar-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }
        
        #ios-permission-panel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            color: white;
            z-index: 10001;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        #ios-start-button {
            margin-top: 20px;
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }
        
        #webar-surface-marker {
            display: none;
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px solid cyan;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 2;
        }
        
        #webar-placement-ui {
            display: none;
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: white;
            font-size: 18px;
            text-shadow: 0 0 5px black;
            z-index: 2;
        }
        
        #model-selector {
            display: none;
            position: absolute;
            bottom: 80px;
            width: 100%;
            text-align: center;
            z-index: 2;
        }
        
        .model-btn {
            margin: 5px;
            padding: 8px 15px;
            background-color: rgba(76, 175, 80, 0.7);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Simple loading spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="arjs-loader">
        <div class="spinner"></div>
        <div>Initializing AR environment...</div>
        <div>Please allow camera access when prompted</div>
    </div>

    <div id="error-panel">
        <h2 id="error-title">AR Not Available</h2>
        <div id="error-message"></div>
        <button id="start-button">Try Again</button>
    </div>

    <div id="ios-permission-panel">
        <h2>AR Experience Ready</h2>
        <p>To start the AR experience, please tap the button below.</p>
        <p>You'll need to allow camera access when prompted.</p>
        <button id="ios-start-button">Start AR</button>
    </div>

    <!-- WebAR.rocks SLAM container -->
    <div id="webar-container">
        <canvas id="webar-canvas"></canvas>
        <div id="webar-surface-marker"></div>
        <div id="webar-placement-ui">Point at a flat surface and tap to place</div>
        <div id="model-selector">
            <button class="model-btn" data-model="box">Simple Box</button>
            <button class="model-btn" data-model="duck">Duck</button>
            <button class="model-btn" data-model="helmet">Helmet</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.querySelector('.arjs-loader');
            const errorPanel = document.getElementById('error-panel');
            const errorTitle = document.getElementById('error-title');
            const errorMessage = document.getElementById('error-message');
            const startButton = document.getElementById('start-button');
            const iosPermissionPanel = document.getElementById('ios-permission-panel');
            const iosStartButton = document.getElementById('ios-start-button');
            
            // WebAR.rocks elements
            const webarContainer = document.getElementById('webar-container');
            const webarCanvas = document.getElementById('webar-canvas');
            const webarSurfaceMarker = document.getElementById('webar-surface-marker');
            const webarPlacementUI = document.getElementById('webar-placement-ui');
            const modelSelector = document.getElementById('model-selector');
            const modelButtons = document.querySelectorAll('.model-btn');
            
            let webarSlam = null;
            let webarScene = null;
            let webarCamera = null;
            let webarRenderer = null;
            let webarContent = null;
            let webarHitTestPosition = null;
            let selectedModel = 'box'; // Default model
            let gltfLoader = new THREE.GLTFLoader();
            
            // Predefined models for better performance on older devices
            const models = {
                box: null,
                duck: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Duck/glTF/Duck.gltf',
                helmet: 'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/FlightHelmet/glTF/FlightHelmet.gltf'
            };
            
            // Check if iOS
            const isIOS = () => {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            };
            
            // Check iOS version (returns major version number or 0 if not iOS)
            const getIOSVersion = () => {
                if (!isIOS()) return 0;
                const v = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/);
                return v ? parseInt(v[1], 10) : 0;
            };
            
            // Show error message
            function showError(title, message) {
                errorTitle.textContent = title;
                errorMessage.textContent = message;
                errorPanel.style.display = 'flex';
                loader.style.display = 'none';
                console.error(title + ": " + message);
            }
            
            // Hide error message
            function hideError() {
                errorPanel.style.display = 'none';
            }
            
            // Initialize WebAR.rocks SLAM
            async function initWebAR() {
                try {
                    webarContainer.style.display = 'block';
                    
                    // Clear previous scene if it exists
                    if (webarScene) {
                        webarScene.traverse(object => {
                            if (object.geometry) object.geometry.dispose();
                            if (object.material) {
                                if (Array.isArray(object.material)) {
                                    object.material.forEach(m => m.dispose());
                                } else {
                                    object.material.dispose();
                                }
                            }
                        });
                    }
                    
                    // Create new Three.js scene with simplified settings for older devices
                    webarScene = new THREE.Scene();
                    webarCamera = new THREE.PerspectiveCamera();
                    
                    // Use simpler renderer settings for older devices
                    const rendererOptions = {
                        canvas: webarCanvas,
                        alpha: true,
                        antialias: false, // Disable antialiasing for better performance
                        powerPreference: 'low-power' // Better for older devices
                    };
                    
                    // iOS 11-12 have issues with certain WebGL features
                    if (isIOS() && getIOSVersion() < 13) {
                        rendererOptions.powerPreference = 'default';
                    }
                    
                    webarRenderer = new THREE.WebGLRenderer(rendererOptions);
                    webarRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // Limit pixel ratio for performance
                    webarRenderer.setSize(window.innerWidth, window.innerHeight);
                    
                    // Create content container
                    webarContent = new THREE.Group();
                    webarScene.add(webarContent);
                    
                    // Add simplified lighting
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                    webarScene.add(ambientLight);
                    
                    // Initialize SLAM with settings optimized for older devices
                    const slamOptions = {
                        renderer: webarRenderer,
                        scene: webarScene,
                        camera: webarCamera,
                        videoElement: webarCanvas,
                        poseMode: 'slam',
                        maxDetectionRate: 10, // Lower detection rate for better performance
                        canvasWidth: Math.min(window.innerWidth, 1024), // Limit resolution
                        canvasHeight: Math.min(window.innerHeight, 1024),
                        onReady: () => {
                            console.log('WebAR.rocks SLAM is ready');
                            loader.style.display = 'none';
                            webarPlacementUI.style.display = 'block';
                            modelSelector.style.display = 'block';
                            
                            // Force canvas update for iOS
                            if (isIOS()) {
                                setTimeout(() => {
                                    webarRenderer.render(webarScene, webarCamera);
                                }, 100);
                            }
                        },
                        onError: (error) => {
                            console.error('WebAR.rocks error:', error);
                            showError("SLAM Error", "Failed to initialize tracking. Please try in a well-lit environment.");
                        },
                        onResize: (width, height) => {
                            webarRenderer.setSize(width, height);
                        }
                    };
                    
                    // For older iOS devices, use simpler settings
                    if (isIOS() && getIOSVersion() < 13) {
                        slamOptions.poseMode = 'slam_without_video';
                        slamOptions.maxDetectionRate = 5;
                    }
                    
                    webarSlam = new WEBARROCKS_THREE.WebARCamera(slamOptions);
                    
                    // Start render loop
                    function animate() {
                        requestAnimationFrame(animate);
                        
                        if (webarSlam && webarSlam.isReady) {
                            webarSlam.update();
                            
                            // Perform hit test for surface detection
                            if (webarSlam.get('poseReady')) {
                                const hitTestResult = webarSlam.hitTest(0.5, 0.5); // Center of screen
                                
                                if (hitTestResult && hitTestResult.length > 0) {
                                    const hit = hitTestResult[0];
                                    webarHitTestPosition = hit.position;
                                    
                                    // Update surface marker
                                    const screenPos = webarSlam.project(hit.position);
                                    webarSurfaceMarker.style.display = 'block';
                                    webarSurfaceMarker.style.left = `${screenPos.x * 100}%`;
                                    webarSurfaceMarker.style.top = `${screenPos.y * 100}%`;
                                } else {
                                    webarSurfaceMarker.style.display = 'none';
                                }
                            }
                            
                            webarRenderer.render(webarScene, webarCamera);
                        }
                    }
                    
                    animate();
                    
                    // Optimized resize handler
                    let resizeTimeout;
                    window.addEventListener('resize', () => {
                        clearTimeout(resizeTimeout);
                        resizeTimeout = setTimeout(() => {
                            if (webarSlam) {
                                webarSlam.resize();
                            }
                        }, 200);
                    });
                    
                    return true;
                } catch (error) {
                    console.error('WebAR.rocks initialization failed:', error);
                    return false;
                }
            }
            
            // Load GLB model with simplified settings
            function loadGLBModel(url, position, callback) {
                const onProgress = (xhr) => {
                    // Optional: show loading progress
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                };
                
                gltfLoader.load(
                    url,
                    (gltf) => {
                        const model = gltf.scene;
                        model.position.copy(position);
                        
                        // Simplify model for better performance
                        model.traverse((node) => {
                            if (node.isMesh) {
                                // Reduce material complexity
                                if (node.material) {
                                    if (Array.isArray(node.material)) {
                                        node.material.forEach(mat => {
                                            mat.roughness = 1.0;
                                            mat.metalness = 0.0;
                                        });
                                    } else {
                                        node.material.roughness = 1.0;
                                        node.material.metalness = 0.0;
                                    }
                                }
                                
                                // Simplify geometry if needed
                                if (node.geometry && node.geometry.attributes.position.count > 5000) {
                                    console.log('Simplifying geometry for better performance');
                                    const simplifiedGeo = node.geometry.clone();
                                    // Note: In a real app, you might want to use a geometry simplifier here
                                    node.geometry = simplifiedGeo;
                                }
                            }
                        });
                        
                        // Adjust scale based on model type
                        if (url.includes('Duck')) {
                            model.scale.set(0.5, 0.5, 0.5);
                        } else if (url.includes('FlightHelmet')) {
                            model.scale.set(0.2, 0.2, 0.2);
                        } else {
                            model.scale.set(0.3, 0.3, 0.3);
                        }
                        
                        callback(model);
                    },
                    onProgress,
                    (error) => {
                        console.error('Error loading GLB model:', error);
                        // Fallback to simple box
                        const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                        const material = new THREE.MeshStandardMaterial({ 
                            color: 0x4CC3D9,
                            roughness: 1.0,
                            metalness: 0.0
                        });
                        const cube = new THREE.Mesh(geometry, material);
                        cube.position.copy(position);
                        callback(cube);
                    }
                );
            }
            
            // Place AR content with simplified settings
            function placeContent(position) {
                if (selectedModel === 'box') {
                    // Create a simple 3D model with optimized settings
                    const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
                    const material = new THREE.MeshStandardMaterial({ 
                        color: 0x4CC3D9,
                        roughness: 1.0,
                        metalness: 0.0
                    });
                    const cube = new THREE.Mesh(geometry, material);
                    cube.position.copy(position);
                    webarContent.add(cube);
                    
                    // Add simple rotation animation
                    function animate() {
                        requestAnimationFrame(animate);
                        cube.rotation.y += 0.005; // Slower rotation for better performance
                    }
                    animate();
                } else {
                    // Load GLB model
                    const modelUrl = models[selectedModel];
                    if (modelUrl) {
                        loadGLBModel(modelUrl, position, (model) => {
                            webarContent.add(model);
                            
                            // Add simple rotation animation
                            function animate() {
                                requestAnimationFrame(animate);
                                model.rotation.y += 0.005; // Slower rotation
                            }
                            animate();
                        });
                    } else {
                        // Fallback to box if model not found
                        selectedModel = 'box';
                        placeContent(position);
                    }
                }
                
                webarSurfaceMarker.style.display = 'none';
                webarPlacementUI.style.display = 'none';
                modelSelector.style.display = 'none';
            }
            
            // Check for AR support (simplified version)
            async function checkARSupport() {
                // WebAR.rocks SLAM is our primary choice as it works on older devices
                if (typeof WEBARROCKS_THREE !== 'undefined' && WEBARROCKS_THREE.isWebARCameraAvailable()) {
                    return 'webar';
                }
                
                return null;
            }
            
            // Start AR experience with simplified flow
            async function startAR() {
                hideError();
                loader.style.display = 'flex';
                iosPermissionPanel.style.display = 'none';
                
                try {
                    // First check if we have camera access
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    
                    // For iOS, we need to stop the stream and let WebAR.rocks handle it
                    if (isIOS()) {
                        stream.getTracks().forEach(track => track.stop());
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                    
                    const arSupport = await checkARSupport();
                    
                    if (!arSupport) {
                        showError("AR Not Supported", 
                            "Your device doesn't support AR features. " +
                            "Please try on a newer device with iOS 11+ or Android 8+.");
                        return;
                    }
                    
                    let initialized = false;
                    
                    if (arSupport === 'webar') {
                        // For iOS, we need to recreate the WebAR.rocks instance after getting permissions
                        if (webarSlam) {
                            webarSlam.destroy();
                            webarSlam = null;
                        }
                        
                        initialized = await initWebAR();
                    }
                    
                    if (!initialized) {
                        showError("Initialization Failed", 
                            "AR couldn't be initialized. Please try in a well-lit environment.");
                    }
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        showError("Camera Access Denied", 
                            "Please allow camera access to use AR features.");
                    } else if (error.name === 'NotFoundError') {
                        showError("Camera Not Found", 
                            "Couldn't access the camera. Please make sure your device has a camera.");
                    } else {
                        showError("AR Error", 
                            "An error occurred: " + (error.message || 'Unknown error'));
                    }
                }
            }
            
            // Handle tap to place (simplified)
            function handleTap(event) {
                if (event.target.tagName === 'BUTTON') return;
                
                if (webarPlacementUI.style.display === 'block' && webarHitTestPosition) {
                    placeContent(webarHitTestPosition.clone());
                }
            }
            
            // Handle model selection
            function handleModelSelection(event) {
                if (event.target.classList.contains('model-btn')) {
                    selectedModel = event.target.dataset.model;
                    
                    // For older devices, preload the selected model
                    if (selectedModel !== 'box' && models[selectedModel]) {
                        const dummyPosition = new THREE.Vector3(0, -100, 0); // Offscreen
                        loadGLBModel(models[selectedModel], dummyPosition, () => {
                            console.log('Model preloaded:', selectedModel);
                        });
                    }
                }
            }
            
            // Add event listeners
            document.addEventListener('click', handleTap);
            startButton.addEventListener('click', startAR);
            iosStartButton.addEventListener('click', startAR);
            modelButtons.forEach(btn => btn.addEventListener('click', handleModelSelection));
            
            // Preload models for better user experience
            function preloadModels() {
                Object.entries(models).forEach(([key, url]) => {
                    if (url) {
                        const dummyPosition = new THREE.Vector3(0, -100, 0); // Offscreen
                        loadGLBModel(url, dummyPosition, () => {
                            console.log('Preloaded model:', key);
                        });
                    }
                });
            }
            
            // Check iOS and handle permissions
            if (isIOS()) {
                // On iOS, we need to wait for a user gesture to request camera
                iosPermissionPanel.style.display = 'flex';
                loader.style.display = 'none';
                
                // Preload models after a short delay
                setTimeout(preloadModels, 1000);
            } else {
                // On other platforms, we can start immediately
                if (document.readyState === 'complete') {
                    startAR();
                } else {
                    window.addEventListener('load', startAR);
                }
                
                // Preload models
                preloadModels();
            }
            
            // Handle device orientation for iOS
            window.addEventListener('orientationchange', () => {
                if (webarSlam) {
                    setTimeout(() => {
                        webarSlam.resize();
                    }, 300);
                }
            });
        });
    </script>
</body>
</html>
