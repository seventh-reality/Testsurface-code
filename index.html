<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>SLAM AR with Surface Tracking</title>
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px;
            z-index: 100;
        }
        
        #reticle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            margin-left: -20px;
            margin-top: -20px;
            border: 3px solid rgba(0, 255, 0, 0.5);
            border-radius: 50%;
            pointer-events: none;
            z-index: 99;
            transition: all 0.1s;
            display: none;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
        }
        
        #start-button {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            z-index: 100;
        }
        
        a-scene {
            position: absolute;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="info">SLAM AR with Surface Tracking - Look around to detect surfaces</div>
    <div id="reticle"></div>
    <div id="loading">Loading AR experience...</div>
    <button id="start-button" style="display: none;">Start AR</button>

    <!-- A-Frame Scene -->
    <a-scene 
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;"
        embedded 
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
    >
        <!-- Camera -->
        <a-entity camera></a-entity>
        
        <!-- This will be our dynamic content -->
        <a-entity id="dynamic-content"></a-entity>
    </a-scene>

    <script>
        // Wait for A-Frame to be ready
        window.addEventListener('load', async () => {
            const scene = document.querySelector('a-scene');
            const reticle = document.getElementById('reticle');
            const loading = document.getElementById('loading');
            const startButton = document.getElementById('start-button');
            const dynamicContent = document.getElementById('dynamic-content');
            
            // Model URL - Replace with your own model
            const modelUrl = 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r132/examples/models/gltf/Duck/glTF/Duck.gltf';
            
            // Track if we have surface detection
            let hasSurfaceDetection = false;
            let hitTestSource = null;
            let hitTestSourceInitialized = false;
            let modelPlaced = false;
            
            // Initialize AR.js with SLAM
            async function initARSession() {
                loading.textContent = "Initializing AR...";
                
                // Wait for scene to be ready
                await new Promise(resolve => {
                    if (scene.hasLoaded) resolve();
                    else scene.addEventListener('loaded', resolve);
                });
                
                // Get the Three.js renderer and camera
                const renderer = scene.renderer;
                const camera = scene.camera;
                const session = scene.systems["arjs"]._arSession;
                const referenceSpace = scene.systems["arjs"]._arReferenceSpace;
                
                // Enable 8th Wall-like features
                if (session && session.requestHitTestSource) {
                    try {
                        // Request hit test source for world tracking
                        hitTestSource = await session.requestHitTestSource({
                            space: referenceSpace
                        });
                        hitTestSourceInitialized = true;
                        
                        // Show reticle when we have surface detection
                        reticle.style.display = 'block';
                        hasSurfaceDetection = true;
                        
                        // Start animation loop
                        renderer.setAnimationLoop(function(timestamp, frame) {
                            if (!frame || !hitTestSourceInitialized || modelPlaced) return;
                            
                            const hitTestResults = frame.getHitTestResults(hitTestSource);
                            
                            if (hitTestResults.length > 0) {
                                const hit = hitTestResults[0];
                                const pose = hit.getPose(referenceSpace);
                                
                                // Update reticle position and color
                                const position = pose.transform.position;
                                const point = new THREE.Vector3(position.x, position.y, position.z);
                                point.applyMatrix4(camera.matrixWorldInverse);
                                
                                // Convert to screen coordinates for reticle
                                const vector = point.clone().project(camera);
                                vector.x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                                vector.y = -(vector.y * 0.5 - 0.5) * window.innerHeight;
                                
                                reticle.style.left = `${vector.x}px`;
                                reticle.style.top = `${vector.y}px`;
                                reticle.style.borderColor = 'rgba(0, 255, 0, 0.8)';
                            } else {
                                reticle.style.borderColor = 'rgba(255, 255, 0, 0.5)';
                            }
                        });
                        
                        loading.style.display = 'none';
                        startButton.style.display = 'none';
                        
                    } catch (error) {
                        console.error("Hit test failed:", error);
                        loading.textContent = "Advanced AR features not supported. Falling back to basic AR.";
                        hasSurfaceDetection = false;
                        reticle.style.display = 'none';
                    }
                } else {
                    loading.textContent = "World tracking not supported. Using basic AR.";
                    hasSurfaceDetection = false;
                    reticle.style.display = 'none';
                }
            }
            
            // Place model at reticle position
            function placeModel() {
                if (modelPlaced) return;
                
                // Get camera position and direction
                const camera = scene.camera;
                const direction = new THREE.Vector3(0, 0, -1);
                direction.applyQuaternion(camera.quaternion);
                
                // Position 1 meter in front of camera
                const position = new THREE.Vector3();
                camera.getWorldPosition(position);
                position.add(direction.multiplyScalar(1));
                
                // Create model entity
                const model = document.createElement('a-entity');
                model.setAttribute('gltf-model', `url(${modelUrl})`);
                model.setAttribute('scale', '0.5 0.5 0.5');
                model.setAttribute('position', position);
                model.setAttribute('animation', {
                    property: 'scale',
                    to: '1 1 1',
                    dur: 500,
                    easing: 'easeOutElastic'
                });
                
                dynamicContent.appendChild(model);
                modelPlaced = true;
                reticle.style.display = 'none';
                
                // Add animation or interaction components as needed
                model.addEventListener('click', () => {
                    model.setAttribute('animation', {
                        property: 'rotation',
                        to: '0 360 0',
                        dur: 2000,
                        loop: true
                    });
                });
            }
            
            // Handle screen taps
            document.addEventListener('click', (e) => {
                if (!modelPlaced && hasSurfaceDetection) {
                    placeModel();
                }
            });
            
            // Start button handler
            startButton.addEventListener('click', () => {
                initARSession();
            });
            
            // Check for WebXR support
            if (navigator.xr) {
                navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                    if (supported) {
                        startButton.style.display = 'block';
                        loading.textContent = "Ready to start AR experience";
                    } else {
                        loading.textContent = "AR not supported on your device";
                    }
                });
            } else {
                loading.textContent = "WebXR not supported in your browser";
            }
        });
    </script>
</body>
</html>
