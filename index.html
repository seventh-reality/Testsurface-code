<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAR with Green Screen Video</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        model-viewer {
            width: 100%;
            height: 100vh;
            background-color: #000;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            text-align: center;
            z-index: 10;
        }
        select {
            padding: 8px 15px;
            border-radius: 10px;
            margin-top: 5px;
            background: #333;
            color: white;
            border: none;
        }
        #tap-to-play {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div id="tap-to-play" style="display: none;">Tap to start video</div>
    <model-viewer 
        id="ar-model"
        camera-controls 
        touch-action="pan-y" 
        src="https://modelviewer.dev/shared-assets/models/sphere.glb" 
        ar 
        ar-modes="webxr scene-viewer quick-look" 
        alt="AR with Green Screen Video"
        xr-environment
    >
    </model-viewer>

    <div class="controls">
        <p>Video Source</p>
        <select id="video-source">
            <option value="greenscreen">Green Screen Video</option>
            <option value="regular">Regular Video</option>
        </select>
    </div>

    <script type="module">
        const modelViewer = document.querySelector("#ar-model");
        const tapToPlay = document.querySelector("#tap-to-play");
        let videoTexture, greenScreenTexture;
        let videoElement, greenScreenElement;

        // iOS requires user interaction to start video playback
        function handleIOSVideoPlayback() {
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                tapToPlay.style.display = 'flex';
                
                return new Promise((resolve) => {
                    const startPlayback = async () => {
                        tapToPlay.style.display = 'none';
                        try {
                            await videoElement.play();
                            await greenScreenElement.play();
                            resolve();
                        } catch (err) {
                            console.error("Video playback error:", err);
                            tapToPlay.textContent = "Video playback failed. Tap to retry.";
                            tapToPlay.style.display = 'flex';
                            tapToPlay.addEventListener('click', startPlayback, { once: true });
                        }
                    };
                    
                    tapToPlay.addEventListener('click', startPlayback, { once: true });
                });
            }
            return Promise.resolve();
        }

        async function createVideoTexture(videoUrl, isGreenScreen = false) {
            return new Promise((resolve, reject) => {
                const video = document.createElement("video");
                video.src = videoUrl;
                video.crossOrigin = "anonymous";
                video.loop = true;
                video.muted = true;
                video.playsInline = true;
                video.preload = "auto";

                // Store references to video elements
                if (isGreenScreen) {
                    greenScreenElement = video;
                } else {
                    videoElement = video;
                }

                const onReady = async () => {
                    try {
                        // For iOS, we'll handle playback after user interaction
                        if (!/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                            await video.play();
                        }
                        const texture = modelViewer.createVideoTexture(video);
                        resolve(texture);
                    } catch (err) {
                        reject(err);
                    }
                };

                video.addEventListener("loadeddata", onReady);
                video.addEventListener("error", () => reject(`Failed to load video: ${videoUrl}`));
            });
        }

        async function setupTextures() {
            try {
                // Create both video textures
                videoTexture = await createVideoTexture(
                    "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
                );
                
                greenScreenTexture = await createVideoTexture(
                    "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4", 
                    true
                );

                // Handle iOS video playback requirement
                await handleIOSVideoPlayback();

                modelViewer.addEventListener("load", () => {
                    const material = modelViewer.model.materials[0];
                    const { baseColorTexture } = material.pbrMetallicRoughness;
                    
                    // Set initial texture
                    baseColorTexture.setTexture(greenScreenTexture);

                    // Handle video source change
                    document.querySelector('#video-source').addEventListener('change', (event) => {
                        baseColorTexture.setTexture(
                            event.target.value === "greenscreen" ? greenScreenTexture : videoTexture
                        );
                    });
                });

            } catch (error) {
                console.error("Texture setup error:", error);
                tapToPlay.textContent = "Error loading videos. Please refresh.";
                tapToPlay.style.display = 'flex';
            }
        }

        // Initialize when model-viewer is ready
        customElements.whenDefined('model-viewer').then(setupTextures);
    </script>
</body>
</html>
