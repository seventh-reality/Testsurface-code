<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>WebAR World Tracking</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #000;
    }
    #camerafeed {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #ar-prompt {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      font-family: Arial, sans-serif;
      background-color: rgba(0,0,0,0.5);
      padding: 10px;
      margin: 0 auto;
      width: 80%;
      border-radius: 20px;
      pointer-events: none;
    }
    .loading-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #000;
      z-index: 1000;
    }
    .loading-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading-container">
    <div class="loading-spinner"></div>
  </div>
  <canvas id="camerafeed"></canvas>
  <div id="ar-prompt">Tap to place objects. Pinch with two fingers to reposition.</div>
  
  <!-- 8th Wall and Three.js libraries -->
  <script src="https://cdn.8thwall.com/web/xrweb/xrweb.js"></script>
  <script src="https://cdn.8thwall.com/web/xrextras/xrextras.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
  
  <!-- Main app code -->
  <script>
// Copyright (c) 2021 8th Wall, Inc.

// Returns a pipeline module that initializes the threejs scene when the camera feed starts, and
// handles subsequent spawning of a glb model whenever the scene is tapped.

/* globals XR8 XRExtras THREE TWEEN */

const placegroundScenePipelineModule = () => {
  const modelFile = 'all.glb' // Your 3D model file
  const startScale = new THREE.Vector3(0.01, 0.01, 0.01)  // Initial scale value for our model
  const endScale = new THREE.Vector3(1, 1, 1)             // Ending scale value for our model
  const animationMillis = 750                             // Animate over 0.75 seconds

  const raycaster = new THREE.Raycaster()
  const tapPosition = new THREE.Vector2()
  const loader = new THREE.GLTFLoader()

  let surface  // Transparent surface for raycasting for object placement.

  // Populates some object into an XR scene and sets the initial camera position.
  const initXrScene = ({scene, camera, renderer}) => {
    renderer.shadowMap.enabled = true
    renderer.shadowMap.type = THREE.PCFSoftShadowMap

    const light = new THREE.DirectionalLight(0xffffff, 1, 100)
    light.position.set(1, 4.3, 2.5)

    scene.add(light)
    scene.add(new THREE.AmbientLight(0x404040, 5))

    light.shadow.mapSize.width = 1024
    light.shadow.mapSize.height = 1024
    light.shadow.camera.near = 0.5
    light.shadow.camera.far = 500
    light.castShadow = true

    surface = new THREE.Mesh(
      new THREE.PlaneGeometry(100, 100, 1, 1),
      new THREE.ShadowMaterial({
        opacity: 0.5,
      })
    )

    surface.rotateX(-Math.PI / 2)
    surface.position.set(0, 0, 0)
    surface.receiveShadow = true
    scene.add(surface)

    camera.position.set(0, 3, 0)
  }

  const animateIn = (model, pointX, pointZ, yDegrees) => {
    const scale = {...startScale}

    model.scene.rotation.set(0.0, yDegrees, 0.0)
    model.scene.position.set(pointX, 0.0, pointZ)
    model.scene.scale.set(scale.x, scale.y, scale.z)
    
    // Enable shadows if model has mesh components
    model.scene.traverse((child) => {
      if (child.isMesh) {
        child.castShadow = true
      }
    })
    
    XR8.Threejs.xrScene().scene.add(model.scene)

    new TWEEN.Tween(scale)
      .to(endScale, animationMillis)
      .easing(TWEEN.Easing.Elastic.Out)
      .onUpdate(() => {
        model.scene.scale.set(scale.x, scale.y, scale.z)
      })
      .start()
  }

  // Load the glb model at the requested point on the surface.
  const placeObject = (pointX, pointZ) => {
    loader.load(
      modelFile,
      (gltf) => {
        animateIn(gltf, pointX, pointZ, Math.random() * 360)
      },
      undefined,
      (error) => {
        console.error('Error loading model:', error)
      }
    )
  }

  const placeObjectTouchHandler = (e) => {
    // Recenter when canvas is tapped with two fingers
    if (e.touches.length === 2) {
      XR8.XrController.recenter()
      return
    }

    if (e.touches.length > 2) {
      return
    }

    // Single tap - place object
    const {camera} = XR8.Threejs.xrScene()

    tapPosition.x = (e.touches[0].clientX / window.innerWidth) * 2 - 1
    tapPosition.y = -(e.touches[0].clientY / window.innerHeight) * 2 + 1

    raycaster.setFromCamera(tapPosition, camera)
    const intersects = raycaster.intersectObject(surface)

    if (intersects.length === 1 && intersects[0].object === surface) {
      placeObject(intersects[0].point.x, intersects[0].point.z)
    }
  }

  return {
    name: 'placeground',

    onStart: ({canvas}) => {
      const {scene, camera, renderer} = XR8.Threejs.xrScene()

      initXrScene({scene, camera, renderer})
      canvas.addEventListener('touchstart', placeObjectTouchHandler, true)

      // Prevent scroll/pinch gestures on canvas
      canvas.addEventListener('touchmove', (event) => {
        event.preventDefault()
      })

      // Enable TWEEN animations
      const animate = (time) => {
        requestAnimationFrame(animate)
        TWEEN.update(time)
      }
      animate()

      XR8.XrController.updateCameraProjectionMatrix({
        origin: camera.position,
        facing: camera.quaternion,
      })
      
      // Hide loading screen when AR starts
      document.getElementById('loading').style.display = 'none';
    },
  }
}

const onxrloaded = () => {
  XR8.addCameraPipelineModules([
    // Add camera pipeline modules.
    XR8.GlTextureRenderer.pipelineModule(),      // Draws the camera feed.
    XR8.Threejs.pipelineModule(),                // Creates a ThreeJS AR Scene.
    XR8.XrController.pipelineModule(),           // Enables SLAM tracking.
    XRExtras.AlmostThere.pipelineModule(),       // Detects unsupported browsers and gives hints.
    XRExtras.FullWindowCanvas.pipelineModule(),  // Modifies the canvas to fill the window.
    XRExtras.Loading.pipelineModule(),           // Manages the loading screen on startup.
    XRExtras.RuntimeError.pipelineModule(),      // Shows an error image on runtime error.
    // Custom pipeline modules.
    placegroundScenePipelineModule(),
  ])

  // Open the camera and start running the camera run loop.
  XR8.run({
    canvas: document.getElementById('camerafeed'),
    ownRunLoop: true,
    cameraConfig: { direction: XR8.XrConfig.camera().BACK }
  }).then(() => {
    console.log('XR8 running successfully');
  }).catch((err) => {
    console.error('Error starting XR8:', err);
    document.getElementById('loading').innerHTML = '<p style="color:white">Failed to start camera. Please check permissions and try again.</p>';
  });
}

// Show loading screen before the full XR library has been loaded.
const load = () => { 
  if (window.XRExtras) {
    XRExtras.Loading.showLoading({onxrloaded});
  } else {
    document.getElementById('loading').innerHTML = '<p style="color:white">Loading AR libraries...</p>';
    window.addEventListener('xrextrasloaded', () => {
      XRExtras.Loading.showLoading({onxrloaded});
    });
  }
}

// Check if device is mobile
const isMobile = () => {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Only load AR if on mobile device
window.onload = () => {
  if (isMobile()) {
    load();
  } else {
    document.getElementById('loading').innerHTML = '<p style="color:white">Please open this page on a mobile device to experience AR.</p>';
  }
}
  </script>
</body>
</html>
