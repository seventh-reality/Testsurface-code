<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>AR Surface Tracking</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #ar-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
        }
        
        #marker-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10;
        }
        
        #start-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="ar-container"></div>
    <div id="loading">Loading AR experience...</div>
    <div id="marker-info">Move your device to detect surfaces</div>
    <button id="start-button" style="display: none;">Start AR</button>

    <!-- Import required libraries -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/effects/OutlineEffect.js"></script>
    <!-- Proper WebXR polyfill for broader device support -->
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.js"></script>
    
    <script>
        // Global variables
        let scene, camera, renderer;
        let model, mixer, clock;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let reticle = null;
        let surfacesDetected = false;
        let xrSession = null;
        
        // DOM elements
        const container = document.getElementById('ar-container');
        const loadingElement = document.getElementById('loading');
        const markerInfo = document.getElementById('marker-info');
        const startButton = document.getElementById('start-button');
        
        // Initialize the AR experience
        init();
        
        function init() {
            // First check if WebXR is supported at all
            if (!window.isSecureContext) {
                loadingElement.textContent = "WebXR requires HTTPS or localhost. Please use a secure context.";
                return;
            }
            
            // Initialize WebXR polyfill
            if (navigator.xr === undefined) {
                const polyfill = new WebXRPolyfill();
            }
            
            // Set up Three.js scene
            scene = new THREE.Scene();
            
            // Set up camera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
            
            // Set up renderer with proper XR configuration
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                preserveDrawingBuffer: true // Required for some AR features
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Add lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 1);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Create reticle for placement
            createReticle();
            
            // Check for AR support
            checkARSupport();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }
        
        function checkARSupport() {
            navigator.xr?.isSessionSupported('immersive-ar').then((supported) => {
                if (supported) {
                    startButton.style.display = 'block';
                    startButton.addEventListener('click', startAR);
                    loadingElement.style.display = 'none';
                } else {
                    loadingElement.textContent = "AR not supported on your device/browser. Try Chrome on Android or Safari on iOS 15+.";
                }
            }).catch(error => {
                console.error("Error checking AR support:", error);
                loadingElement.textContent = "Error checking AR capabilities. See console for details.";
            });
        }
        
        function createReticle() {
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.1, 0.11, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
        }
        
        async function setupHitTest() {
            if (!xrSession) return;
            
            try {
                // Create a reference space of type 'viewer' for hit testing
                const viewerSpace = await xrSession.requestReferenceSpace('viewer');
                hitTestSource = await xrSession.requestHitTestSource({ 
                    space: viewerSpace 
                });
                hitTestSourceRequested = true;
            } catch (error) {
                console.error("Error setting up hit test:", error);
                markerInfo.textContent = "Surface detection not available";
            }
        }
        
        function onXRFrame(time, frame) {
            if (!xrSession) return;
            
            const referenceSpace = renderer.xr.getReferenceSpace();
            const pose = frame.getViewerPose(referenceSpace);
            
            if (pose) {
                // Update camera position
                const view = pose.views[0];
                camera.matrix.fromArray(view.transform.matrix);
                camera.matrix.decompose(camera.position, camera.quaternion, camera.scale);
                
                // Perform hit test if available
                if (hitTestSource) {
                    const hitTestResults = frame.getHitTestResults(hitTestSource);
                    
                    if (hitTestResults.length > 0) {
                        const hit = hitTestResults[0];
                        const hitPose = hit.getPose(referenceSpace);
                        
                        if (hitPose) {
                            reticle.visible = true;
                            reticle.matrix.fromArray(hitPose.transform.matrix);
                            
                            if (!surfacesDetected) {
                                surfacesDetected = true;
                                markerInfo.textContent = "Surface detected! Tap to place object.";
                                container.addEventListener('click', placeModel, { once: true });
                            }
                        }
                    } else {
                        reticle.visible = false;
                    }
                }
            }
            
            // Update animations if any
            if (mixer) {
                mixer.update(clock.getDelta());
            }
            
            renderer.render(scene, camera);
        }
        
        function placeModel() {
            if (!reticle.visible) return;
            
            scene.remove(reticle);
            const loader = new THREE.GLTFLoader();
            clock = new THREE.Clock();
            
            loader.load(
                'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@2.0/~/2.0/Fox/glTF-Binary/Fox.glb',
                (gltf) => {
                    model = gltf.scene;
                    model.position.setFromMatrixPosition(reticle.matrix);
                    model.quaternion.setFromRotationMatrix(reticle.matrix);
                    model.scale.set(0.05, 0.05, 0.05);
                    
                    if (gltf.animations?.length) {
                        mixer = new THREE.AnimationMixer(model);
                        mixer.clipAction(gltf.animations[0]).play();
                    }
                    
                    scene.add(model);
                    markerInfo.textContent = "Object placed! Move around to view.";
                },
                undefined,
                (error) => {
                    console.error("Error loading model:", error);
                    markerInfo.textContent = "Error loading model. See console.";
                }
            );
        }
        
        async function startAR() {
            startButton.style.display = 'none';
            loadingElement.textContent = "Starting AR session...";
            loadingElement.style.display = 'block';
            
            try {
                // Request AR session with required features
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });
                
                xrSession.addEventListener('end', onSessionEnded);
                
                await renderer.xr.setSession(xrSession);
                await setupHitTest();
                
                // Start the AR render loop
                renderer.setAnimationLoop(onXRFrame);
                
                loadingElement.style.display = 'none';
                markerInfo.textContent = "Move your device to detect surfaces";
            } catch (error) {
                console.error("AR session error:", error);
                loadingElement.textContent = `Failed to start AR: ${error.message}`;
                startButton.style.display = 'block';
            }
        }
        
        function onSessionEnded() {
            if (!xrSession) return;
            
            renderer.setAnimationLoop(null);
            xrSession.removeEventListener('end', onSessionEnded);
            xrSession = null;
            
            startButton.style.display = 'block';
            markerInfo.textContent = "AR session ended";
            surfacesDetected = false;
            
            // Clean up
            if (model) {
                scene.remove(model);
                model = null;
            }
            
            if (reticle && !scene.children.includes(reticle)) {
                scene.add(reticle);
                reticle.visible = false;
            }
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
