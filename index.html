<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>AR Surface Tracking</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #ar-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
        }
        
        #marker-info {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10;
        }
        
        #start-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="ar-container"></div>
    <div id="loading">Loading AR experience...</div>
    <div id="marker-info">Move your device to detect surfaces</div>
    <button id="start-button" style="display: none;">Start AR</button>

    <!-- Import required libraries -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/effects/OutlineEffect.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.0/dist/ar.js"></script>
    
    <script>
        // Global variables
        let scene, camera, renderer, controller, effect;
        let model, mixer, clock;
        let arWorldRoot;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let reticle = null;
        let surfacesDetected = false;
        
        // DOM elements
        const container = document.getElementById('ar-container');
        const loadingElement = document.getElementById('loading');
        const markerInfo = document.getElementById('marker-info');
        const startButton = document.getElementById('start-button');
        
        // Initialize the AR experience
        init();
        
        function init() {
            // Check if WebXR is available
            if (!navigator.xr) {
                loadingElement.textContent = "WebXR not supported in your browser. Try Chrome or Safari on iOS 15+.";
                return;
            }
            
            // Set up Three.js scene
            scene = new THREE.Scene();
            
            // Set up camera
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
            
            // Set up renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Add some ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 1);
            scene.add(ambientLight);
            
            // Add directional light
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Create a reticle for surface placement
            createReticle();
            
            // Set up AR
            setupAR();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Show start button
            startButton.style.display = 'block';
            startButton.addEventListener('click', startAR);
        }
        
        function setupAR() {
            // Create AR.js controller
            controller = new THREEx.ArToolkitSource({
                sourceType: 'webcam',
            });
            
            controller.init(function onReady() {
                // Hide loading when AR is ready
                loadingElement.style.display = 'none';
            });
            
            // Handle AR.js controller resize
            THREEx.ArToolkitContext.baseURL = 'https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.0/data/';
            
            const arContext = new THREEx.ArToolkitContext({
                cameraParametersUrl: THREEx.ArToolkitContext.baseURL + 'data/camera_para.dat',
                detectionMode: 'mono',
                maxDetectionRate: 30,
                canvasWidth: 80 * 3,
                canvasHeight: 60 * 3,
            });
            
            // Initialize AR.js
            arContext.init(function onCompleted() {
                // Copy projection matrix to camera
                camera.projectionMatrix.copy(arContext.getProjectionMatrix());
            });
            
            // Update AR scene on every frame
            renderer.setAnimationLoop(function onAnimationFrame(time, frame) {
                if (frame && renderer.xr.isPresenting) {
                    // Update AR context
                    arContext.update();
                    
                    // Update camera with AR context
                    camera.matrixAutoUpdate = false;
                    
                    // Get the pose of the device
                    const referenceSpace = renderer.xr.getReferenceSpace();
                    const pose = frame.getViewerPose(referenceSpace);
                    
                    if (pose) {
                        // Update camera position
                        const view = pose.views[0];
                        const viewport = renderer.xr.getViewport(view);
                        renderer.setViewport(viewport);
                        
                        camera.matrix.fromArray(view.transform.matrix);
                        camera.matrix.decompose(camera.position, camera.quaternion, camera.scale);
                        
                        // Perform hit test for surface detection
                        if (!surfacesDetected) {
                            performHitTest(frame, referenceSpace);
                        }
                    }
                }
                
                // Update model animation if exists
                if (mixer) {
                    mixer.update(clock.getDelta());
                }
                
                // Render the scene
                renderer.render(scene, camera);
            });
        }
        
        function createReticle() {
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.1, 0.11, 32).rotateX(-Math.PI / 2),
                new THREE.MeshBasicMaterial({ color: 0xffffff })
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
        }
        
        async function performHitTest(frame, referenceSpace) {
            if (!hitTestSource && !hitTestSourceRequested) {
                hitTestSourceRequested = true;
                
                try {
                    const session = renderer.xr.getSession();
                    hitTestSource = await session.requestReferenceSpace('viewer');
                    hitTestSource = await session.requestHitTestSource({ space: hitTestSource });
                } catch (error) {
                    console.error('Error setting up hit test:', error);
                }
            }
            
            if (hitTestSource) {
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const hitPose = hit.getPose(referenceSpace);
                    
                    if (hitPose) {
                        reticle.visible = true;
                        reticle.matrix.fromArray(hitPose.transform.matrix);
                        
                        // Show that surfaces are detected
                        if (!surfacesDetected) {
                            surfacesDetected = true;
                            markerInfo.textContent = "Surface detected! Tap to place object.";
                            
                            // Add click event to place model
                            container.addEventListener('click', placeModel, { once: true });
                        }
                    }
                } else {
                    reticle.visible = false;
                }
            }
        }
        
        function placeModel() {
            if (!reticle.visible) return;
            
            // Remove the reticle
            scene.remove(reticle);
            
            // Load GLB model
            const loader = new THREE.GLTFLoader();
            clock = new THREE.Clock();
            
            loader.load(
                'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@2.0/~/2.0/Fox/glTF-Binary/Fox.glb',
                function (gltf) {
                    model = gltf.scene;
                    
                    // Position model where reticle was
                    model.position.copy(reticle.position);
                    model.quaternion.copy(reticle.quaternion);
                    model.scale.set(0.05, 0.05, 0.05);
                    
                    // Play animation if exists
                    if (gltf.animations && gltf.animations.length) {
                        mixer = new THREE.AnimationMixer(model);
                        const action = mixer.clipAction(gltf.animations[0]);
                        action.play();
                    }
                    
                    scene.add(model);
                    markerInfo.textContent = "Object placed! Move around to view it.";
                },
                undefined,
                function (error) {
                    console.error('Error loading model:', error);
                    markerInfo.textContent = "Error loading model. See console for details.";
                }
            );
        }
        
        function startAR() {
            startButton.style.display = 'none';
            
            // Request AR session
            navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['hit-test'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.body }
            }).then(onSessionStarted)
            .catch(error => {
                console.error('Error starting AR session:', error);
                loadingElement.textContent = "Error starting AR. Make sure your device supports AR and you're using HTTPS.";
                loadingElement.style.display = 'block';
            });
        }
        
        function onSessionStarted(session) {
            session.addEventListener('end', onSessionEnded);
            
            renderer.xr.setSession(session)
            .then(() => {
                loadingElement.style.display = 'none';
            });
        }
        
        function onSessionEnded() {
            renderer.xr.setSession(null);
            startButton.style.display = 'block';
            markerInfo.textContent = "Move your device to detect surfaces";
            surfacesDetected = false;
            
            // Clean up
            if (model) {
                scene.remove(model);
                model = null;
            }
            
            if (reticle && !scene.children.includes(reticle)) {
                scene.add(reticle);
                reticle.visible = false;
            }
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
